<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Realtime</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .success {
            background: #d4edda;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        #notifications {
            margin-top: 20px;
        }

        .notification {
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            border-radius: 4px;
        }

        input {
            padding: 8px;
            margin: 5px;
            width: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ”” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Realtime</h1>

        <div id="status"></div>

        <div>
            <h3>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:</h3>
            <input type="number" id="userId" placeholder="User ID" value="1">
            <input type="text" id="apiToken" placeholder="API Token" value="">
            <button onclick="saveSettings()">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </div>

        <div style="margin-top: 20px;">
            <button onclick="connect()">Ø§ØªØµØ§Ù„ Ø¨Ù€ Pusher</button>
            <button onclick="subscribe()">Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
            <button onclick="testNotification()">Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø´Ø¹Ø§Ø±</button>
            <button onclick="disconnect()">Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„</button>
        </div>

        <div id="connectionInfo" style="margin-top: 20px;"></div>

        <div id="notifications">
            <h3>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©:</h3>
            <div id="notificationsList"></div>
        </div>
    </div>

    <!-- Laravel Echo Ùˆ Pusher -->
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Pusher
        const PUSHER_KEY = 'e91ff80f1a87987e5a08';
        const PUSHER_CLUSTER = 'eu';
        const AUTH_ENDPOINT = '/api/broadcasting/auth';

        let pusher = null;
        let channel = null;
        let userId = null;
        let apiToken = null;

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateConnectionInfo() {
            const infoDiv = document.getElementById('connectionInfo');
            if (!pusher) {
                infoDiv.innerHTML = '<div class="status error">ØºÙŠØ± Ù…ØªØµÙ„</div>';
                return;
            }

            const state = pusher.connection.state;
            const isSubscribed = channel && channel.subscribed;

            infoDiv.innerHTML = `
                <div class="status ${state === 'connected' ? 'success' : 'error'}">
                    <strong>Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„:</strong> ${state}
                </div>
                <div class="status ${isSubscribed ? 'success' : 'warning'}">
                    <strong>Channel:</strong> ${channel ? `private-user.${userId}` : 'ØºÙŠØ± Ù…Ø´ØªØ±Ùƒ'}
                    ${isSubscribed ? '(Ù…Ø´ØªØ±Ùƒ)' : '(ØºÙŠØ± Ù…Ø´ØªØ±Ùƒ)'}
                </div>
            `;
        }

        function saveSettings() {
            userId = document.getElementById('userId').value;
            apiToken = document.getElementById('apiToken').value;

            if (apiToken) {
                localStorage.setItem('api_token', apiToken);
            } else {
                apiToken = localStorage.getItem('api_token');
            }

            if (!userId || !apiToken) {
                updateStatus('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ User ID Ùˆ API Token', 'warning');
                return;
            }

            updateStatus(`âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: User ID = ${userId}`, 'success');
        }

        function connect() {
            userId = document.getElementById('userId').value || localStorage.getItem('user_id') || '1';
            apiToken = document.getElementById('apiToken').value || localStorage.getItem('api_token');
            
            if (!apiToken) {
                updateStatus('âŒ API Token Ù…Ø·Ù„ÙˆØ¨!', 'error');
                return;
            }
            
            updateStatus('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Pusher...', 'info');
            console.log('Connecting to Pusher with:', {
                key: PUSHER_KEY.substring(0, 10) + '...',
                cluster: PUSHER_CLUSTER,
                authEndpoint: AUTH_ENDPOINT,
                tokenPreview: apiToken.substring(0, 10) + '...'
            });
            
            // Ø¥Ù†Ø´Ø§Ø¡ Pusher instance
            pusher = new Pusher(PUSHER_KEY, {
                cluster: PUSHER_CLUSTER,
                forceTLS: true,
                encrypted: true,
                authEndpoint: AUTH_ENDPOINT,
                auth: {
                    headers: {
                        'Authorization': 'Bearer ' + apiToken,
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                },
                enabledTransports: ['ws', 'wss']
            });

            // Event listeners
            pusher.connection.bind('connected', () => {
                updateStatus('âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Pusher Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                updateConnectionInfo();
            });

            pusher.connection.bind('disconnected', () => {
                updateStatus('âŒ ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ù† Pusher', 'error');
                updateConnectionInfo();
            });

            pusher.connection.bind('error', (err) => {
                updateStatus(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${err.error ? err.error.message : JSON.stringify(err)}`, 'error');
                console.error('Pusher connection error:', err);
            });

            pusher.connection.bind('state_change', (states) => {
                console.log('Connection state changed:', states.previous, '->', states.current);
                updateConnectionInfo();
            });
        }

        function subscribe() {
            if (!pusher) {
                updateStatus('âŒ ÙŠØ¬Ø¨ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Pusher Ø£ÙˆÙ„Ø§Ù‹!', 'error');
                return;
            }

            userId = document.getElementById('userId').value || userId || '1';

            if (!userId) {
                updateStatus('âŒ User ID Ù…Ø·Ù„ÙˆØ¨!', 'error');
                return;
            }

            // Ù‚Ø·Ø¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ù† ÙˆØ¬Ø¯
            if (channel) {
                pusher.unsubscribe(`private-user.${userId}`);
            }

            updateStatus(`ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ channel: private-user.${userId}...`, 'info');

            // Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ private channel
            channel = pusher.subscribe(`private-user.${userId}`);

            // Event listeners Ù„Ù„Ù€ channel
            channel.bind('pusher:subscription_succeeded', () => {
                updateStatus(`âœ… ØªÙ… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ channel Ø¨Ù†Ø¬Ø§Ø­: private-user.${userId}`, 'success');
                updateConnectionInfo();
                console.log('âœ… Subscription succeeded for channel:', `private-user.${userId}`);
            });

            channel.bind('pusher:subscription_error', (status) => {
                let errorMessage = `âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ channel: ${JSON.stringify(status)}`;
                
                console.error('Subscription error details:', {
                    status: status,
                    statusCode: status?.status || status,
                    channel: `private-user.${userId}`,
                    userId: userId,
                    tokenPreview: apiToken ? apiToken.substring(0, 10) + '...' : 'NOT SET'
                });
                
                if (status === 403 || (typeof status === 'object' && status.status === 403)) {
                    errorMessage += '<br><br><strong>ğŸ” Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:</strong> Channel Authorization ÙØ§Ø´Ù„ (403 Forbidden)<br>';
                    errorMessage += '<strong>âœ… Ø§Ù„Ø­Ù„:</strong><br>';
                    errorMessage += '1. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† User ID ØµØ­ÙŠØ­ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ù‡)<br>';
                    errorMessage += '2. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† API Token ØµØ­ÙŠØ­ ÙˆÙ…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…<br>';
                    errorMessage += '3. ØªØ­Ù‚Ù‚ Ù…Ù† Logs: storage/logs/laravel.log<br>';
                    errorMessage += '4. Ø§Ø¨Ø­Ø« Ø¹Ù†: "Broadcasting channel authorization"<br><br>';
                    errorMessage += '<strong>ğŸ’¡ Ù†ØµÙŠØ­Ø©:</strong> Ø§Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ User ID Ù…Ù† API response Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
                } else if (status === 401 || (typeof status === 'object' && status.status === 401)) {
                    errorMessage += '<br><br><strong>ğŸ” Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:</strong> Authentication ÙØ§Ø´Ù„ (401 Unauthorized)<br>';
                    errorMessage += '<strong>âœ… Ø§Ù„Ø­Ù„:</strong> ØªØ­Ù‚Ù‚ Ù…Ù† API Token ÙÙŠ localStorage';
                } else if (typeof status === 'object' && status.error) {
                    errorMessage += '<br><br><strong>ğŸ” Ø§Ù„Ø®Ø·Ø£:</strong> ' + status.error;
                }
                
                updateStatus(errorMessage, 'error');
            });

            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ø¯Ø« notification.sent
            channel.bind('notification.sent', (data) => {
                updateStatus(`âœ… Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯ Ù…Ø³ØªÙ„Ù…!`, 'success');
                console.log('Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯:', data);

                // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
                const notificationsList = document.getElementById('notificationsList');
                const notificationDiv = document.createElement('div');
                notificationDiv.className = 'notification';
                notificationDiv.innerHTML = `
                    <strong>${data.title}</strong><br>
                    <small>${data.message}</small><br>
                    <small style="color: #666;">${new Date(data.created_at).toLocaleString('ar-SA')}</small>
                `;
                notificationsList.insertBefore(notificationDiv, notificationsList.firstChild);

                // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ØªØµÙØ­
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification(data.title, {
                        body: data.message,
                        icon: '/images/logo.png'
                    });
                }
            });
        }

        function testNotification() {
            if (!channel || !channel.subscribed) {
                updateStatus('âŒ ÙŠØ¬Ø¨ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ channel Ø£ÙˆÙ„Ø§Ù‹!', 'error');
                return;
            }

            updateStatus('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ...', 'info');

            // Ø¥Ø±Ø³Ø§Ù„ request Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø¹Ø§Ø±
            fetch('/api/v1/notifications/test', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + (apiToken || localStorage.getItem('api_token')),
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    user_id: userId,
                    type: 'system',
                    title: 'Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù† Frontend',
                    message: 'Ù‡Ø°Ø§ Ø¥Ø´Ø¹Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ'
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateStatus('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±! Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹...', 'success');
                    } else {
                        updateStatus(`âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±: ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    updateStatus(`âŒ Ø®Ø·Ø£: ${error.message}`, 'error');
                    console.error('Error:', error);
                });
        }

        function disconnect() {
            if (channel) {
                pusher.unsubscribe(`private-user.${userId}`);
                channel = null;
            }

            if (pusher) {
                pusher.disconnect();
                pusher = null;
            }

            updateStatus('ğŸ”Œ ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„', 'info');
            updateConnectionInfo();
        }

        // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        window.addEventListener('load', () => {
            const savedUserId = localStorage.getItem('user_id');
            const savedApiToken = localStorage.getItem('api_token');

            if (savedUserId) {
                document.getElementById('userId').value = savedUserId;
            }

            if (savedApiToken) {
                document.getElementById('apiToken').value = savedApiToken;
            }

            updateStatus('ğŸ“‹ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±. Ø£Ø¯Ø®Ù„ User ID Ùˆ API Token Ø«Ù… Ø§Ø¶ØºØ· "Ø§ØªØµØ§Ù„"', 'info');
        });
    </script>
</body>

</html>